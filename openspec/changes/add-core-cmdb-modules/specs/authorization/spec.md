## ADDED Requirements

### Requirement: 角色创建
系统 SHALL 支持创建新的角色，用于权限管理。

#### Scenario: 成功创建角色
- **WHEN** 管理员提供有效的角色信息（名称、描述）
- **THEN** 系统创建角色记录并返回角色 ID
- **AND** 角色信息保存到数据库
- **AND** 创建操作记录到审计日志

#### Scenario: 创建角色时缺少必填字段
- **WHEN** 管理员提交缺少必填字段（如名称）的角色信息
- **THEN** 系统返回 400 错误和字段验证错误信息

#### Scenario: 创建角色时名称重复
- **WHEN** 管理员尝试创建与现有角色同名的角色
- **THEN** 系统返回 409 冲突错误，提示名称已存在

### Requirement: 角色查询
系统 SHALL 支持查询和列出角色记录。

#### Scenario: 查询所有角色
- **WHEN** 管理员请求角色列表
- **THEN** 系统返回所有角色记录的分页列表
- **AND** 包含角色的基本信息（ID、名称、描述、权限数量、创建时间）

#### Scenario: 查询单个角色详情
- **WHEN** 管理员请求特定角色 ID 的详情
- **THEN** 系统返回该角色的完整信息
- **AND** 包含角色关联的所有权限列表

#### Scenario: 查询不存在的角色
- **WHEN** 管理员请求不存在的角色 ID
- **THEN** 系统返回 404 错误

### Requirement: 角色更新
系统 SHALL 支持更新现有角色的信息。

#### Scenario: 成功更新角色信息
- **WHEN** 管理员提供有效的角色 ID 和更新数据
- **THEN** 系统更新角色记录
- **AND** 返回更新后的角色信息
- **AND** 更新操作记录到审计日志

#### Scenario: 更新角色时名称重复
- **WHEN** 管理员尝试将角色名称更新为已存在的名称
- **THEN** 系统返回 409 冲突错误，提示名称已存在

#### Scenario: 更新不存在的角色
- **WHEN** 管理员尝试更新不存在的角色 ID
- **THEN** 系统返回 404 错误

### Requirement: 角色删除
系统 SHALL 支持删除角色。

#### Scenario: 成功删除角色
- **WHEN** 管理员请求删除角色
- **THEN** 系统删除角色记录
- **AND** 删除角色与权限的关联关系
- **AND** 删除角色与用户/群组的关联关系
- **AND** 删除操作记录到审计日志
- **AND** 返回成功响应

#### Scenario: 删除不存在的角色
- **WHEN** 管理员尝试删除不存在的角色 ID
- **THEN** 系统返回 404 错误

### Requirement: 权限管理
系统 SHALL 支持创建和查询权限，权限由资源（resource）和操作（action）组成。

#### Scenario: 成功创建权限
- **WHEN** 管理员提供有效的权限信息（名称、资源、操作）
- **THEN** 系统创建权限记录并返回权限 ID
- **AND** 权限信息保存到数据库

#### Scenario: 查询所有权限
- **WHEN** 管理员请求权限列表
- **THEN** 系统返回所有权限记录
- **AND** 包含权限的基本信息（ID、名称、资源、操作）

#### Scenario: 按资源查询权限
- **WHEN** 管理员请求特定资源（如 assets）的所有权限
- **THEN** 系统仅返回该资源的权限记录

#### Scenario: 查询权限详情
- **WHEN** 管理员请求特定权限 ID 的详情
- **THEN** 系统返回该权限的完整信息
- **AND** 包含关联该权限的所有角色列表

### Requirement: 角色权限分配
系统 SHALL 支持为角色分配权限和撤销权限。

#### Scenario: 成功为角色分配权限
- **WHEN** 管理员请求为角色分配权限
- **THEN** 系统创建角色权限关联记录
- **AND** 分配操作记录到审计日志
- **AND** 拥有该角色的用户和群组自动获得该权限

#### Scenario: 为角色分配已存在的权限
- **WHEN** 管理员尝试为角色分配已存在的权限
- **THEN** 系统返回 409 冲突错误，提示权限已分配

#### Scenario: 成功撤销角色权限
- **WHEN** 管理员请求撤销角色的权限
- **THEN** 系统删除角色权限关联记录
- **AND** 撤销操作记录到审计日志
- **AND** 拥有该角色的用户和群组失去该权限

#### Scenario: 查询角色的权限列表
- **WHEN** 管理员请求角色的权限列表
- **THEN** 系统返回该角色关联的所有权限
- **AND** 包含权限的详细信息

### Requirement: 用户角色分配
系统 SHALL 支持为用户直接分配角色和撤销角色。

#### Scenario: 成功为用户分配角色
- **WHEN** 管理员请求为用户分配角色
- **THEN** 系统创建用户角色关联记录
- **AND** 用户获得该角色的所有权限
- **AND** 分配操作记录到审计日志

#### Scenario: 为用户分配已存在的角色
- **WHEN** 管理员尝试为用户分配已存在的角色
- **THEN** 系统返回 409 冲突错误，提示角色已分配

#### Scenario: 成功撤销用户角色
- **WHEN** 管理员请求撤销用户的角色
- **THEN** 系统删除用户角色关联记录
- **AND** 用户失去该角色的所有权限
- **AND** 撤销操作记录到审计日志

#### Scenario: 查询用户的角色列表
- **WHEN** 管理员请求用户的角色列表
- **THEN** 系统返回该用户直接分配的所有角色
- **AND** 包含角色的详细信息

### Requirement: 群组角色分配
系统 SHALL 支持为群组分配角色和撤销角色，群组成员通过群组继承角色。

#### Scenario: 成功为群组分配角色
- **WHEN** 管理员请求为群组分配角色
- **THEN** 系统创建群组角色关联记录
- **AND** 群组的所有成员自动获得该角色的所有权限
- **AND** 分配操作记录到审计日志

#### Scenario: 为群组分配已存在的角色
- **WHEN** 管理员尝试为群组分配已存在的角色
- **THEN** 系统返回 409 冲突错误，提示角色已分配

#### Scenario: 成功撤销群组角色
- **WHEN** 管理员请求撤销群组的角色
- **THEN** 系统删除群组角色关联记录
- **AND** 群组的所有成员失去该角色的所有权限
- **AND** 撤销操作记录到审计日志

#### Scenario: 查询群组的角色列表
- **WHEN** 管理员请求群组的角色列表
- **THEN** 系统返回该群组关联的所有角色
- **AND** 包含角色的详细信息

### Requirement: 权限检查
系统 SHALL 支持检查用户是否具有特定资源的操作权限。

#### Scenario: 用户具有直接角色权限
- **WHEN** 用户请求执行操作，且用户直接分配的角色具有该权限
- **THEN** 系统允许操作继续执行

#### Scenario: 用户通过群组继承权限
- **WHEN** 用户请求执行操作，且用户所属群组的角色具有该权限
- **THEN** 系统允许操作继续执行

#### Scenario: 用户不具有权限
- **WHEN** 用户请求执行操作，但用户既没有直接角色权限，也没有通过群组继承权限
- **THEN** 系统返回 403 禁止访问错误
- **AND** 权限检查失败记录到审计日志

#### Scenario: 权限检查中间件拦截
- **WHEN** 用户访问受保护的 API 端点
- **THEN** 系统通过权限检查中间件验证用户权限
- **AND** 如果权限不足，请求在到达业务逻辑前被拦截

#### Scenario: 查询用户的所有权限
- **WHEN** 管理员请求用户的所有权限列表
- **THEN** 系统返回用户通过直接角色和群组继承的所有权限
- **AND** 明确标识权限来源（直接角色或群组）

### Requirement: 权限继承
系统 SHALL 支持用户通过群组继承角色的权限。

#### Scenario: 用户加入群组后获得权限
- **WHEN** 用户被添加到具有角色的群组
- **THEN** 用户自动获得该群组所有角色的权限
- **AND** 权限立即生效

#### Scenario: 用户离开群组后失去权限
- **WHEN** 用户从群组中移除
- **THEN** 用户失去通过该群组获得的所有权限
- **AND** 权限立即失效

#### Scenario: 群组角色变更影响成员权限
- **WHEN** 群组的角色被添加或移除
- **THEN** 群组的所有成员自动获得或失去相应权限
- **AND** 权限变更立即生效

